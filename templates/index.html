<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Proto</title>
        <link rel="stylesheet" href="/pico.css">
        <style>
            /* https://grid.layoutit.com/ */
            .container {  
                max-width: 100%;
                display: grid;
                grid-template-columns: 2fr 1fr;
                grid-template-rows: 1fr;
                gap: 0em 1em;
                grid-auto-flow: row;
                grid-template-areas: "terrain parameter";
            }

            .terrain { grid-area: terrain; }

            .parameter { grid-area: parameter; }

            canvas {
                height: 100vh;
                width: 100%;
                display: block;
            }
        </style>
        <script type="importmap">
            {
            "imports": {
            "alpinejs": "/vendor/alpinejs/dist/module.esm.js",
            "@babylonjs/": "/vendor/@babylonjs/",
            "terrain": "/app/Terrain.js",
            "TransfertFunction": "/app/TransfertFunction.js",
            "terrain-editor": "/app/editor.js"
            }
            }
        </script>
    </head>
    <body>
        <div class="container" x-data="spa">
            <div class="terrain">
                <canvas x-ref="renderCanvas"></canvas>
            </div>
            <div class="parameter">
                <h4>Hello from Pico </h4>
                <form x-data="spa">
                    <input type="range" x-model="distance" min="0" max="100" step="any" value="50"/>
                    <button x-on:click.prevent="valid">yolo</button>
                </form>
            </div>
        </div>

        <script type="module">
            import { Terrain } from 'terrain';
            import { TransfertFunction } from 'TransfertFunction';
            import * as TerrainEditor from 'terrain-editor';
            import Alpine from 'alpinejs';

            // outside of AlpineJS because the property will be proxyed, it will slow down and it bugs with private members
            let terrain = null

            Alpine.data('spa', () => ({
                    tesselation: 8,
                    pctAltitude: 50,
                    textureTiling: 20,
                    slopeThreshold: 0.5,
                    heightSeparation: 0.5,
                    mixSeparation: 7,

                    init() {
                        terrain = new Terrain(this.tesselation)
                        terrain.generate()
                        TerrainEditor.createEditor(this.$refs.renderCanvas, 2 * terrain.getSide())
                        this.updateView()
                    },

                    loadTexture(event, name) {
                        let reader = new FileReader()
                        reader.onload = () => {
                            this.$refs[name + 'Texture'].src = reader.result
                            TerrainEditor.updateTexture(name, reader)
                            TerrainEditor.updateTiling(this.textureTiling)
                        }
                        reader.readAsDataURL(event.target.files[0])
                    },

                    regenerate(event) {
                        terrain = new Terrain(this.tesselation)
                        terrain.generate()
                        this.updateView()
                    },

                    getHeightMax() {
                        return terrain.getSide() * this.pctAltitude / 100.0
                    },

                    changeTiling() {
                        TerrainEditor.updateTiling(this.textureTiling)
                    },

                    increaseTessel(event) {
                        this.tesselation++
                        terrain.increaseTesselation()
                        this.updateView()
                        TerrainEditor.moveAway(2)
                    },

                    decreaseTessel(event) {
                        this.tesselation--
                        terrain.decreaseTesselation()
                        this.updateView()
                        TerrainEditor.moveAway(0.5)
                    },

                    updateView() {
                        TerrainEditor.show(terrain, this.getHeightMax(), this.slopeThreshold, this.heightSeparation, this.mixSeparation)
                    }
                }))

            Alpine.data('tfWidget', (step) => ({
                    tfChoice: 'identity',
                    repository: {
                        identity: new TransfertFunction(x => x, -1, 1),
                        sigmoid1: new TransfertFunction(x => Math.tanh(x), -1, 1),
                        'square root': new TransfertFunction(x => x / Math.sqrt(1 + x ** 2), -1, 1),
                        sinus: new TransfertFunction(x => Math.sin(x), -Math.PI / 2, Math.PI / 2),
                        sigmoid2: new TransfertFunction(x => Math.tanh(x), -2, 2),
                        sigmoid3: new TransfertFunction(x => Math.tanh(x), -3, 3)
                    },

                    getTfCurve(choice) {
                        let path = null
                        let tf = this.repository[choice]

                        for (let x = 0; x < 1; x += 1 / step) {
                            let y = tf.getY(x)
                            if (path === null) {
                                path = 'M '
                            } else {
                                path += ' L '
                            }
                            path += x + ' ' + (1 - y)  // reminder : y-axis is inverted in SVG
                        }

                        return path
                    },

                    applyTf(event) {
                        terrain.applyTransferFunction(this.repository[this.tfChoice])
                        this.updateView()
                        this.tfChoice = 'identity'
                    }
                }))

            Alpine.data('convolutionWidget', (step) => ({
                    convChoice: 'identity',
                    repository: {
                        identity: [[1]],
                        smoothing: [[1, 1, 1], [1, 1, 1], [1, 1, 1]],
                        gaussian3: [[0.6, 1.5, 2.1, 1.5, 0.6], [1.5, 4.1, 5.7, 4.1, 1.5], [2.1, 5.7, 8, 5.7, 2.1], [1.5, 4.1, 5.7, 4.1, 1.5], [0.6, 1.5, 2.1, 1.5, 0.6]],
                        bumpy: [[1, 1, 1], [1, -7, 1], [1, 1, 1]]
                    },

                    applyConvolution(event) {
                        terrain.applyConvolution(this.repository[this.convChoice])
                        this.updateView()
                        this.convChoice = 'identity'
                    }
                }))

            Alpine.start()
        </script>
    </body>
</html>